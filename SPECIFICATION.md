# Toggl Clone 完全仕様書

## 目次

1. [システム概要](#1-システム概要)
2. [技術スタック](#2-技術スタック)
3. [データベース設計](#3-データベース設計)
4. [機能仕様](#4-機能仕様)
   - 4.1 [認証機能](#41-認証機能)
   - 4.2 [タイマー機能](#42-タイマー機能)
   - 4.3 [プロジェクト管理](#43-プロジェクト管理)
   - 4.4 [タグ管理](#44-タグ管理)
   - 4.5 [レポート機能](#45-レポート機能)
   - 4.6 [ダッシュボード](#46-ダッシュボード)
   - 4.7 [設定機能](#47-設定機能)
5. [非機能要件](#5-非機能要件)
6. [画面設計](#6-画面設計)
7. [API設計](#7-api設計)
8. [環境構築とデプロイ](#8-環境構築とデプロイ)

---

## 1. システム概要

### 1.1 システムの目的
Toggl Cloneは、フリーランサーやチームが作業時間を効率的に記録・管理し、プロジェクトごとの時間配分を可視化することで生産性向上を支援するWebアプリケーションです。

### 1.2 主要機能
- リアルタイムタイマーによる時間記録
- プロジェクトによる作業分類
- 時間ベースのレポートと分析
- マルチデバイス対応とリアルタイム同期

### 1.3 対象ユーザー
- フリーランサー
- リモートワーカー
- プロジェクトマネージャー
- 小規模チーム

---

## 2. 技術スタック

### 2.1 フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **状態管理**: Zustand
- **フォーム**: React Hook Form + Zod
- **日付処理**: date-fns
- **グラフ**: Recharts
- **アイコン**: Lucide React

### 2.2 バックエンド
- **BaaS**: Supabase
  - 認証: Supabase Auth
  - データベース: PostgreSQL
  - リアルタイム: Supabase Realtime
  - ストレージ: Supabase Storage

### 2.3 インフラ・デプロイ
- **ホスティング**: Vercel
- **環境**: 
  - Development（開発環境）
  - Preview（プレビュー環境）
  - Production（本番環境）

---

## 3. データベース設計

### 3.1 テーブル構造

#### profiles（ユーザープロファイル）
| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK, FK(auth.users) | ユーザーID |
| email | TEXT | UNIQUE, NOT NULL | メールアドレス |
| full_name | TEXT | | フルネーム |
| avatar_url | TEXT | | アバター画像URL |
| week_starts_on | INTEGER | DEFAULT 1 | 週の開始日(1=月曜) |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新日時 |

#### projects（プロジェクト）
| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | プロジェクトID |
| user_id | UUID | FK(profiles), NOT NULL | ユーザーID |
| name | TEXT | NOT NULL | プロジェクト名 |
| color | TEXT | DEFAULT '#5E5CE6' | カラーコード |
| is_active | BOOLEAN | DEFAULT true | アクティブフラグ |
| notes | TEXT | | メモ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新日時 |

#### time_entries（タイムエントリー）
| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | エントリーID |
| user_id | UUID | FK(profiles), NOT NULL | ユーザーID |
| project_id | UUID | FK(projects) | プロジェクトID |
| description | TEXT | | 作業内容 |
| start_time | TIMESTAMPTZ | NOT NULL | 開始時刻 |
| end_time | TIMESTAMPTZ | | 終了時刻 |
| duration | INTEGER | | 作業時間（秒） |
| is_running | BOOLEAN | DEFAULT false | 実行中フラグ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新日時 |

#### client_logs（クライアントログ）
| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | UUID | PK | ログID |
| user_id | UUID | FK(profiles) | ユーザーID（ゲストはNULL） |
| session_id | TEXT | NOT NULL | セッションID |
| log_level | TEXT | CHECK IN ('debug','info','warn','error','fatal') | ログレベル |
| message | TEXT | NOT NULL | ログメッセージ |
| error_stack | TEXT | | エラースタックトレース |
| user_agent | TEXT | | ユーザーエージェント |
| url | TEXT | | 発生URL |
| timestamp | TIMESTAMPTZ | NOT NULL | 発生時刻 |
| metadata | JSONB | | 追加メタデータ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 記録日時 |

### 3.2 インデックス
- `idx_time_entries_user_date`: time_entries(user_id, start_time)
- `idx_time_entries_running`: time_entries(user_id, is_running) WHERE is_running = true
- `idx_projects_user_active`: projects(user_id, is_active)
- `idx_client_logs_user_id`: client_logs(user_id)
- `idx_client_logs_timestamp`: client_logs(timestamp DESC)
- `idx_client_logs_level`: client_logs(log_level)
- `idx_client_logs_session`: client_logs(session_id)

### 3.3 Row Level Security (RLS)
全テーブルでRLSを有効化し、ユーザーは自分のデータのみアクセス可能

---

## 4. 機能仕様

### 4.1 認証機能

#### 4.1.1 ユーザー登録
**機能要件**:
- メールアドレスとパスワードで登録
- パスワード要件: 8文字以上、大文字小文字数字を含む
- メールアドレスの重複チェック
- 登録後、確認メール送信
- 確認リンククリックで本登録完了

**データ処理**:
- `auth.users`テーブルにレコード作成（Supabase Auth）
- `profiles`テーブルに自動的にプロファイル作成（トリガー）

**テスト項目**:
1. 正常系
   - [ ] 有効なメールアドレスとパスワードで登録成功
   - [ ] 確認メールが送信される
   - [ ] 確認リンククリックで本登録完了
   - [ ] profilesテーブルにレコードが作成される
2. 異常系
   - [ ] 既存のメールアドレスで登録失敗（エラーメッセージ表示）
   - [ ] 無効なメールアドレス形式で登録失敗
   - [ ] パスワードが8文字未満で登録失敗
   - [ ] パスワードに大文字が含まれない場合登録失敗
   - [ ] パスワードに小文字が含まれない場合登録失敗
   - [ ] パスワードに数字が含まれない場合登録失敗
   - [ ] 確認メールの有効期限切れでエラー

#### 4.1.2 ログイン
**機能要件**:
- メールアドレスとパスワードでログイン
- "ログイン状態を保持"オプション
- 5回連続失敗で一時的にアカウントロック（15分）
- ログイン成功後、ダッシュボードへリダイレクト

**データ処理**:
- Supabase AuthでJWTトークン発行
- セッション情報をクッキーに保存

**テスト項目**:
1. 正常系
   - [ ] 正しい認証情報でログイン成功
   - [ ] ログイン状態保持オプションが機能する
   - [ ] ダッシュボードへ正しくリダイレクト
   - [ ] JWTトークンが正しく発行される
2. 異常系
   - [ ] 間違ったパスワードでログイン失敗
   - [ ] 存在しないメールアドレスでログイン失敗
   - [ ] 未確認メールアドレスでログイン失敗
   - [ ] 5回連続失敗後のログイン試行で失敗
   - [ ] アカウントロック後15分経過でログイン可能

#### 4.1.3 パスワードリセット
**機能要件**:
- メールアドレス入力でリセットメール送信
- リセットリンクの有効期限: 24時間
- 新パスワード設定後、全デバイスからログアウト

**テスト項目**:
1. 正常系
   - [ ] 登録済みメールアドレスでリセットメール送信成功
   - [ ] リセットリンクから新パスワード設定画面へ遷移
   - [ ] 新パスワード設定成功
   - [ ] 新パスワードでログイン可能
   - [ ] 全デバイスからログアウトされる
2. 異常系
   - [ ] 存在しないメールアドレスでエラー表示
   - [ ] 24時間経過後のリンクでエラー
   - [ ] 新パスワードが要件を満たさない場合エラー
   - [ ] 使用済みリセットリンクでエラー

### 4.2 タイマー機能

#### 4.2.1 タイマーバー
**機能要件**:

**説明文入力フィールド**
- 最大500文字
- プレースホルダー: "What are you working on?"
- オートコンプリート機能
  - `time_entries`テーブルから過去7日間の`description`を取得
  - 部分一致で最大10件表示
  - 使用頻度順でソート

**プロジェクト選択**
- `projects`テーブルから`is_active=true`のデータ取得
- 最近使用した5件を上部表示
  - `time_entries`から直近のプロジェクトID取得
- "No Project"オプションを最後に表示
- 選択時、プロジェクトの色でドロップダウンのボーダー色変更

**タイマー表示**
- フォーマット: HH:MM:SS
- 24時間超過時: "1d 01:23:45"
- 実行中は赤文字
- ページリロード時の復元
  - `time_entries`から`is_running=true`のレコード取得

**テスト項目**:
1. 正常系
   - [ ] 説明文を500文字まで入力できる
   - [ ] 説明文のオートコンプリートが動作する
   - [ ] プロジェクトドロップダウンにアクティブプロジェクトのみ表示
   - [ ] 最近使用したプロジェクトが上部に表示される
   - [ ] タイマーが1秒ごとに更新される
   - [ ] 24時間超過時の表示が正しい
   - [ ] ページリロード後もタイマーが継続する
2. 異常系
   - [ ] 説明文が500文字を超えると入力できない
   - [ ] アーカイブされたプロジェクトが表示されない

#### 4.2.2 タイマー開始処理
**処理フロー**:
1. `time_entries`で`user_id`かつ`is_running=true`の確認
2. 新規エントリー作成（`time_entries`テーブル）
   - description, project_id, start_time, is_running=true
3. UIをタイマー実行中状態に更新

**テスト項目**:
1. 正常系
   - [ ] タイマー開始でtime_entriesにレコード作成
   - [ ] is_running=trueが設定される
   - [ ] UIがタイマー実行中状態になる
   - [ ] スペースキーでタイマー開始できる
2. 異常系
   - [ ] 既に実行中のタイマーがある場合エラー表示
   - [ ] ネットワークエラー時の処理
   - [ ] データベースエラー時のロールバック

#### 4.2.3 タイマー停止処理
**処理フロー**:
1. 実行中エントリーの`time_entries`レコード取得
2. レコード更新
   - end_time, duration, is_running=false
3. UIリセットとエントリーリスト更新
4. 今日の合計時間再計算

**テスト項目**:
1. 正常系
   - [ ] タイマー停止でend_timeが記録される
   - [ ] durationが正しく計算される
   - [ ] is_running=falseに更新される
   - [ ] エントリーリストに即座に反映される
   - [ ] 今日の合計時間が更新される
   - [ ] UIがリセットされる
2. 異常系
   - [ ] 実行中でないタイマーの停止試行でエラー
   - [ ] 他ユーザーのタイマーを停止できない
   - [ ] ネットワークエラー時の処理

#### 4.2.4 タイムエントリーリスト
**機能要件**:
- データ取得
  - `time_entries`と`projects`をJOIN
  - デフォルトは今日のエントリー
  - `start_time`降順でソート
- グループ化
  - 日付でグループ（今日、昨日、日付）
  - 各グループに小計表示
- アクション
  - 継続: 同じ内容で新規タイマー開始
  - 編集: インライン編集
  - 削除: 確認後削除

**テスト項目**:
1. 正常系
   - [ ] 今日のエントリーがデフォルトで表示される
   - [ ] エントリーが時刻の降順で表示される
   - [ ] 日付ごとにグループ化される
   - [ ] 各グループの小計が正しく計算される
   - [ ] 継続ボタンで同じ内容のタイマー開始
   - [ ] インライン編集で各項目を変更できる
   - [ ] 削除確認ダイアログが表示される
2. 異常系
   - [ ] 他ユーザーのエントリーが表示されない
   - [ ] 編集中に他で変更された場合の競合処理
   - [ ] 実行中のエントリーは削除できない

#### 4.2.5 手動エントリー作成
**機能要件**:
- 日付選択（過去90日まで）
- 開始・終了時刻入力
- 時間重複チェック
  - `time_entries`で時間範囲の重複確認
- 最大24時間まで

**テスト項目**:
1. 正常系
   - [ ] 過去90日以内の日付で作成できる
   - [ ] 開始・終了時刻を正しく設定できる
   - [ ] 時間幅入力で終了時刻が自動計算される
   - [ ] プロジェクトを設定できる
   - [ ] 作成後リストに表示される
2. 異常系
   - [ ] 91日以前の日付で作成エラー
   - [ ] 未来の日付で作成エラー
   - [ ] 終了時刻が開始時刻より前でエラー
   - [ ] 24時間を超える入力でエラー
   - [ ] 既存エントリーと時間が重複する場合警告表示

### 4.3 プロジェクト管理

#### 4.3.1 プロジェクト一覧
**機能要件**:
- データ取得
  - `projects`テーブルから全プロジェクト
  - `time_entries`とJOINして統計情報取得
    - 合計時間、今週の時間、エントリー数、最終使用日
- フィルタリング
  - Active/Archived（`is_active`フィールド）
  - 検索（プロジェクト名）
- ソート
  - 最終更新日、名前、作業時間、作成日

**テスト項目**:
1. 正常系
   - [ ] アクティブプロジェクトのみ表示（デフォルト）
   - [ ] アーカイブタブでアーカイブ済みプロジェクト表示
   - [ ] プロジェクト名で検索できる
   - [ ] 部分一致検索が動作する
   - [ ] 大文字小文字を区別しない検索
   - [ ] 各ソート条件で正しく並び替え
   - [ ] 統計情報（合計時間、今週の時間）が正しく表示
2. 異常系
   - [ ] 他ユーザーのプロジェクトが表示されない
   - [ ] 削除されたプロジェクトが表示されない

#### 4.3.2 プロジェクト作成
**機能要件**:
- 入力項目
  - プロジェクト名（必須、最大100文字、重複不可）
  - カラー（12色から選択）
  - メモ（任意、最大1000文字）
- 保存処理
  - `projects`テーブルに新規レコード作成

**テスト項目**:
1. 正常系
   - [ ] 必須項目のみで作成成功
   - [ ] 全項目入力で作成成功
   - [ ] 作成後一覧画面に遷移
   - [ ] 作成したプロジェクトが表示される
   - [ ] デフォルトカラーが設定される
   - [ ] is_active=trueで作成される
2. 異常系
   - [ ] プロジェクト名未入力でエラー
   - [ ] プロジェクト名101文字でエラー
   - [ ] 同名のプロジェクトでエラー

#### 4.3.3 プロジェクト削除
**機能要件**:
- 関連エントリーの処理選択
  - 保持: `project_id`をnullに更新
  - 削除: 関連エントリーも削除
- トランザクション処理で実行

**テスト項目**:
1. 正常系
   - [ ] 削除確認ダイアログが表示される
   - [ ] 関連エントリー数が表示される
   - [ ] 「エントリーを保持」選択で削除成功
   - [ ] 保持したエントリーのproject_id=null
   - [ ] 「エントリーも削除」選択で削除成功
   - [ ] 関連エントリーも削除される
   - [ ] 一覧から削除される
2. 異常系
   - [ ] 他ユーザーのプロジェクトを削除できない
   - [ ] 処理選択なしで削除ボタンが無効
   - [ ] トランザクションエラー時のロールバック

## 4. 機能仕様

### 4.1 認証機能

#### 4.4.1 サマリーレポート
**機能要件**:
- 期間選択（プリセット/カスタム）
- グループ化（プロジェクト/日付）
- データ取得
  - `time_entries`から期間内データ
  - 指定グループでGROUP BY
  - 合計時間を計算
- ビジュアライゼーション
  - 円グラフ（割合）
  - 棒グラフ（推移）

**テスト項目**:
1. 正常系
   - [ ] プリセット期間（今日/昨日/今週/先週/今月/先月）で正しくフィルタリング
   - [ ] カスタム期間で正しくフィルタリング
   - [ ] プロジェクト別グループ化が正しい
   - [ ] 日付別グループ化が正しい
   - [ ] 合計時間が正しく計算される
   - [ ] 円グラフの割合が正しい
   - [ ] 棒グラフの値が正しい
2. 異常系
   - [ ] 未来の期間でデータなし
   - [ ] 1年以上の期間でエラー
   - [ ] データがない期間で適切な表示

#### 4.4.2 詳細レポート
**機能要件**:
- フィルタリング（プロジェクト）
- ページネーション（50/100/200件）
- インライン編集
- 一括操作（プロジェクト変更、削除）

**テスト項目**:
1. 正常系
   - [ ] プロジェクトフィルタが動作
   - [ ] ページネーションが正しく動作
   - [ ] 50/100/200件の切り替えが動作
   - [ ] インライン編集で各項目を変更できる
   - [ ] 複数行選択ができる（Shift/Ctrl）
   - [ ] 一括プロジェクト変更ができる
   - [ ] 一括削除ができる
   - [ ] 合計時間が正しく表示される
2. 異常系
   - [ ] 他ユーザーのデータが表示されない
   - [ ] 編集権限のないデータを編集できない
   - [ ] ページ範囲外のアクセスでエラー

#### 4.4.3 エクスポート
**機能要件**:
- CSV形式
  - 固定フォーマット（YYYY/MM/DD HH:mm:ss）
  - タイムゾーン（Asia/Tokyo固定）
- PDF形式
  - シンプルなレポート形式
  - ロゴアップロード対応

**テスト項目**:
1. 正常系
   - [ ] CSVエクスポートが成功
   - [ ] 日時が正しいフォーマットで出力
   - [ ] フィルタ条件が適用される
   - [ ] PDFエクスポートが成功
   - [ ] カスタムロゴが表示される
   - [ ] 大量データ（1000件以上）のエクスポート
2. 異常系
   - [ ] エクスポート中のキャンセル
   - [ ] 無効な画像ファイルのアップロード
   - [ ] ストレージ容量不足時のエラー

### 4.5 ダッシュボード

#### 4.5.1 統計カード
**機能要件**:
- 今日の作業時間
  - `time_entries`から今日のデータ集計
  - 実行中タイマーを加算
- 今週/今月の作業時間
- 日次目標との比較

**テスト項目**:
1. 正常系
   - [ ] 今日の作業時間が正しく表示される
   - [ ] 実行中タイマーの時間がリアルタイム加算される
   - [ ] 今週の作業時間が正しい（週の開始日設定に従う）
   - [ ] 今月の作業時間が正しい
   - [ ] 前日/前週/前月との比較が正しい
   - [ ] 日次目標の達成率が正しく計算される
   - [ ] 目標未設定時の表示が適切
2. 異常系
   - [ ] データ取得エラー時の表示
   - [ ] タイムゾーン変更時の再計算

#### 4.5.2 アクティビティ表示
**機能要件**:
- 過去7日間の日別グラフ
- アクティブプロジェクトの進捗
- 最近のアクティビティ（10件）

**テスト項目**:
1. 正常系
   - [ ] 7日間の棒グラフが正しく表示される
   - [ ] グラフホバーで詳細表示
   - [ ] 目標ラインが表示される
   - [ ] アクティブプロジェクトTop5が表示される
   - [ ] プロジェクトの進捗バーが正しい
   - [ ] 最近のアクティビティが時系列で表示
   - [ ] 相対時間表示が正しい（"2時間前"）
   - [ ] "もっと見る"で追加読み込み
2. 異常系
   - [ ] データなし時の表示
   - [ ] グラフ描画エラー時の処理

#### 4.5.3 カスタマイズ
**機能要件**:
- ウィジェットのドラッグ&ドロップ
- サイズ変更（S/M/L）
- レイアウト保存

**テスト項目**:
1. 正常系
   - [ ] ウィジェットをドラッグで移動できる
   - [ ] ドロップで配置変更が保存される
   - [ ] サイズ変更（S/M/L）ができる
   - [ ] レイアウトがローカルストレージに保存
   - [ ] ページリロード後もレイアウト維持
   - [ ] デフォルトに戻すボタンが機能
   - [ ] ウィジェットの追加/削除ができる
2. 異常系
   - [ ] 無効な配置へのドロップ防止
   - [ ] ローカルストレージ容量超過時の処理

### 4.6 設定機能

#### 4.6.1 プロファイル設定
**機能要件**:
- 基本情報編集
  - 表示名、アバター
  - 週の開始日
- `profiles`テーブル更新

**テスト項目**:
1. 正常系
   - [ ] 表示名を変更できる
   - [ ] アバター画像をアップロードできる
   - [ ] 週の開始日変更がカレンダーに反映される
   - [ ] 保存成功メッセージが表示される
   - [ ] profilesテーブルが更新される
2. 異常系
   - [ ] 無効な画像ファイルでエラー
   - [ ] 大きすぎる画像（5MB以上）でエラー
   - [ ] 表示名が空でエラー
   - [ ] ネットワークエラー時の処理

#### 4.6.2 通知設定
**機能要件**:
- メール通知（日次/週次レポート）
- ブラウザ通知
- 長時間タイマー警告

**テスト項目**:
1. 正常系
   - [ ] 日次レポートのON/OFF切り替え
   - [ ] 週次レポートのON/OFF切り替え
   - [ ] 送信時刻を設定できる
   - [ ] ブラウザ通知の許可リクエスト
   - [ ] ブラウザ通知のテスト送信
   - [ ] 長時間警告の閾値設定（1-8時間）
   - [ ] 設定が保存される
2. 異常系
   - [ ] ブラウザ通知が拒否された場合の表示
   - [ ] メール送信エラー時の処理

#### 4.6.3 データ管理
**機能要件**:
- エクスポート（全データ/期間指定）
- インポート（CSV/JSON）
- データ削除（期間指定/全削除）

**テスト項目**:
1. 正常系
   - [ ] 全データのJSONエクスポート成功
   - [ ] 全データのCSVエクスポート成功
   - [ ] 期間指定エクスポートが正しくフィルタリング
   - [ ] CSVインポートが成功
   - [ ] JSONインポートが成功
   - [ ] インポート時の重複チェック
   - [ ] インポート進捗が表示される
   - [ ] 期間指定削除が正しく動作
   - [ ] 全データ削除の確認ステップ
   - [ ] アカウント削除の確認メール送信
2. 異常系
   - [ ] 無効なフォーマットのインポートエラー
   - [ ] 他ユーザーのデータインポート防止
   - [ ] 削除の取り消し不可警告
   - [ ] ストレージ容量不足時のエラー

### 4.7 エラーログ収集機能

#### 4.7.1 自動ログ収集
**機能要件**:
- JavaScriptエラーの自動捕捉
- コンソールログの自動収集（開発環境のみ）
- ネットワークエラーの記録
- Promise rejectionの捕捉
- セッションIDによるログのグループ化

**収集する情報**:
- エラーメッセージとスタックトレース
- 発生時刻とURL
- ユーザーエージェント
- セッションID（ブラウザセッション識別用）
- ユーザーID（ログイン時のみ）

**データ処理**:
- `client_logs`テーブルに保存
- バッチ処理（10件または5秒ごと）
- 送信失敗時はローカルストレージに保存

**テスト項目**:
1. 正常系
   - [ ] JavaScriptエラーが自動的に記録される
   - [ ] 未処理のPromise rejectionが記録される
   - [ ] コンソールログが収集される（開発環境）
   - [ ] バッチ送信が正しく動作する
   - [ ] セッションIDが一貫している
   - [ ] ユーザーIDが正しく紐付けられる
2. 異常系
   - [ ] ログ送信失敗時にローカル保存される
   - [ ] 大量ログでメモリリークしない
   - [ ] 循環参照エラーが発生しない
   - [ ] ネットワーク切断時も動作継続

#### 4.7.2 手動エラー報告
**機能要件**:
- 問題報告ボタン（ヘッダーに配置）
- エラー報告フォーム
  - 問題の説明（必須、最大1000文字）
  - 発生した画面の自動記録
  - 直近10件のログを自動添付
- 送信確認と成功通知

**テスト項目**:
1. 正常系
   - [ ] 報告フォームが表示される
   - [ ] 説明文を入力できる
   - [ ] 現在のURLが記録される
   - [ ] 直近のログが含まれる
   - [ ] 送信成功通知が表示される
2. 異常系
   - [ ] 説明文未入力でエラー
   - [ ] 1000文字超過でエラー
   - [ ] 送信失敗時のエラー表示

#### 4.7.3 ログビューワー（管理者用）
**機能要件**:
- ログ一覧表示
  - 新しい順で表示
  - ページネーション（50件/100件/200件）
- フィルタリング機能
  - ユーザーID
  - セッションID
  - ログレベル（debug/info/warn/error/fatal）
  - 期間指定
- ログ詳細表示
  - スタックトレース
  - メタデータ
  - 関連ログ（同一セッション）
- エクスポート機能（CSV）

**テスト項目**:
1. 正常系
   - [ ] ログ一覧が表示される
   - [ ] 各フィルターが正しく動作する
   - [ ] ページネーションが動作する
   - [ ] ログ詳細が表示される
   - [ ] CSVエクスポートができる
2. 異常系
   - [ ] 権限のないユーザーはアクセス不可
   - [ ] 大量データでも表示速度維持
   - [ ] 無効なフィルター値でエラーにならない

#### 4.7.4 プライバシーとセキュリティ
**機能要件**:
- 個人情報のマスキング
  - パスワードフィールドは記録しない
  - APIキーなどの機密情報を除外
- データ保持期間
  - ログは30日で自動削除
  - 重要なエラーは手動でアーカイブ可能
- アクセス制御
  - 管理者のみログビューワーにアクセス可能
  - ユーザーは自分のログのみ作成可能

**テスト項目**:
1. 正常系
   - [ ] パスワード入力値が記録されない
   - [ ] 30日経過したログが削除される
   - [ ] 管理者のみログビューワーにアクセス可能
2. 異常系
   - [ ] 一般ユーザーがログビューワーにアクセス不可
   - [ ] 他ユーザーのログを作成できない

### 5.1 パフォーマンス
- ページ読み込み: 3秒以内
- API応答: 1秒以内
- リアルタイム更新: 100ms以内

### 5.2 セキュリティ
- HTTPS必須
- JWT認証
- XSS/CSRF対策
- Row Level Security

### 5.3 可用性
- 稼働率: 99.9%
- 自動バックアップ
- エラー監視

### 5.4 使いやすさ
- レスポンシブデザイン
- キーボードショートカット
- オフライン対応
- 日本語インターフェース
- 固定フォーマット（日時：YYYY/MM/DD HH:mm:ss）
- 固定タイムゾーン（Asia/Tokyo）

---

## 6. 画面設計

### 6.1 画面構成
```
┌─────────────────────────────────────────────────────────┐
│  Logo    Timer(00:00:00)    User ▼                     │ Header
├────────┬────────────────────────────────────────────────┤
│ Menu   │                Content Area                    │
│        │                                                │
└────────┴────────────────────────────────────────────────┘
```

### 6.2 主要画面
1. ログイン/サインアップ
2. ダッシュボード
3. タイマー
4. プロジェクト
5. レポート
6. 設定

### 6.3 レスポンシブ対応
- デスクトップ: フルレイアウト
- タブレット: サイドバー折りたたみ
- モバイル: ボトムナビゲーション

---

## 7. API設計

### 7.1 認証API
- POST /api/auth/signup - ユーザー登録
- POST /api/auth/login - ログイン
- POST /api/auth/logout - ログアウト
- POST /api/auth/reset-password - パスワードリセット

### 7.2 タイムエントリーAPI
- GET /api/time-entries - 一覧取得
- POST /api/time-entries - 新規作成
- PATCH /api/time-entries/:id - 更新
- DELETE /api/time-entries/:id - 削除
- POST /api/time-entries/start - タイマー開始
- PATCH /api/time-entries/:id/stop - タイマー停止

### 7.3 プロジェクトAPI
- GET /api/projects - 一覧取得
- POST /api/projects - 新規作成
- PATCH /api/projects/:id - 更新
- DELETE /api/projects/:id - 削除

### 7.4 レポートAPI
- GET /api/reports/summary - サマリー取得
- GET /api/reports/detailed - 詳細レポート
- POST /api/reports/export - エクスポート

### 7.5 エラーログAPI
- POST /api/client-logs - ログ送信（バッチ）
- GET /api/client-logs - ログ一覧取得（管理者のみ）
- POST /api/error-report - 手動エラー報告

---

## 8. 環境構築とデプロイ

### 8.1 開発環境セットアップ

#### 8.1.1 必要な環境
- Node.js 18.17.0以上
- npm または yarn
- Git
- Supabaseアカウント
- Vercelアカウント

#### 8.1.2 プロジェクト作成
```bash
# Supabaseテンプレートを使用してプロジェクト作成
npx create-next-app@latest toggl-clone -e with-supabase

# プロジェクトディレクトリに移動
cd toggl-clone

# 追加パッケージのインストール
npm install zustand react-hook-form @hookform/resolvers zod date-fns recharts lucide-react

# 開発用パッケージ（エラーログ収集用）
npm install -D @types/node
```

#### 8.1.3 Supabaseプロジェクトのセットアップ
1. [Supabase Dashboard](https://app.supabase.com)で新規プロジェクト作成
2. プロジェクト設定から以下を取得:
   - Project URL
   - anon public key
3. `.env.local`ファイルに環境変数を設定:
```env
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

#### 8.1.4 データベースのセットアップ
Supabase SQL Editorで、仕様書に記載のテーブル作成SQLを実行

### 8.2 ディレクトリ構造
`npx create-next-app -e with-supabase`で生成される構造をベースに拡張:
```
toggl-clone/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   └── signup/
│   ├── (dashboard)/
│   │   ├── dashboard/
│   │   ├── timer/
│   │   ├── projects/
│   │   └── reports/
│   ├── api/
│   └── auth/
├── components/
├── lib/
├── utils/
│   └── supabase/
│       ├── client.ts
│       ├── server.ts
│       └── middleware.ts
├── .env.local
├── next.config.js
├── package.json
└── tsconfig.json
```

### 8.3 Vercelへのデプロイ

#### 8.3.1 初回デプロイ
```bash
# Vercel CLIのインストール（グローバル）
npm i -g vercel

# Vercelにログイン
vercel login

# プロジェクトをVercelにリンク
vercel

# 環境変数の設定を促されたら、Supabaseの情報を入力
```

#### 8.3.2 環境変数の設定
Vercelダッシュボードで以下の環境変数を設定:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

#### 8.3.3 自動デプロイの設定
1. GitHubリポジトリとVercelプロジェクトを連携
2. mainブランチへのpushで自動的に本番環境にデプロイ
3. プルリクエストでプレビュー環境を自動生成

#### 8.3.4 環境の使い分け
- **Development**: ローカル開発環境（`npm run dev`）
- **Preview**: プルリクエストごとの確認環境
- **Production**: 本番環境（mainブランチ）

### 8.4 開発フロー
```bash
# 機能ブランチの作成
git checkout -b feature/timer-function

# 開発
npm run dev

# コミット
git add .
git commit -m "feat: タイマー機能を実装"

# プッシュ
git push origin feature/timer-function

# GitHubでプルリクエスト作成
# → Vercelが自動的にプレビュー環境を作成

# マージ後、自動的に本番環境にデプロイ
```

## 9. テスト戦略

### 9.1 テストレベル
1. **単体テスト** - Jest + React Testing Library
   - ユーティリティ関数
   - カスタムフック
   - 個別コンポーネント

2. **統合テスト** - Jest + MSW (Mock Service Worker)
   - API連携
   - 状態管理
   - コンポーネント間連携

3. **E2Eテスト** - Playwright
   - 主要ユーザーフロー
   - クロスブラウザテスト

### 9.2 テストカバレッジ目標
- 単体テスト: 80%以上
- 統合テスト: 主要機能の70%以上
- E2Eテスト: クリティカルパスの100%

### 9.3 テスト環境
- ローカル開発環境
- CI/CD（GitHub Actions）
- Vercelプレビュー環境

1. **環境構築**（0.5日）
   - `npx create-next-app -e with-supabase`でプロジェクト作成
   - Supabaseプロジェクト作成とDB設定
   - Vercelプロジェクト作成

2. **認証機能**（2-3日）
   - Supabase Authを使用した認証実装
   - ログイン/サインアップページ

3. **基本レイアウト**（1日）
   - ヘッダー、サイドバー、レイアウト

4. **タイマー機能**（3-4日）
   - タイマーコンポーネント
   - エントリー管理

5. **プロジェクト管理**（2日）

6. **レポート機能**（2-3日）

7. **ダッシュボード**（1日）

8. **設定機能**（1日）

9. **エラーログ収集機能**（1日）

10. **最終調整とテスト**（1日）

合計: 約13-14営業日

この仕様書に基づいて、`npx create-next-app -e with-supabase`を使用して開発を開始し、Vercelにデプロイすることで、効率的にToggl Cloneアプリケーションを構築できます。

---

## 11. 実装TODOリスト

### 📋 プロジェクト初期設定

#### 環境構築
- [ ] `npx create-next-app@latest toggl-clone -e with-supabase` 実行
- [ ] 追加パッケージインストール（zustand, react-hook-form, zod, date-fns, recharts, lucide-react）
- [ ] TypeScript設定確認
- [ ] ESLint/Prettier設定
- [ ] .env.local作成

#### Supabase設定
- [ ] Supabaseプロジェクト作成
- [ ] 環境変数設定（NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY）
- [ ] データベーステーブル作成
  - [ ] profiles テーブル
  - [ ] projects テーブル
  - [ ] time_entries テーブル
  - [ ] client_logs テーブル
- [ ] インデックス作成
  - [ ] idx_time_entries_user_date
  - [ ] idx_time_entries_running
  - [ ] idx_projects_user_active
  - [ ] idx_client_logs_user_id
  - [ ] idx_client_logs_timestamp
  - [ ] idx_client_logs_level
  - [ ] idx_client_logs_session
- [ ] RLS（Row Level Security）設定
  - [ ] profiles テーブルのポリシー
  - [ ] projects テーブルのポリシー
  - [ ] time_entries テーブルのポリシー
  - [ ] client_logs テーブルのポリシー
- [ ] トリガー作成
  - [ ] プロファイル自動作成トリガー
  - [ ] updated_at自動更新トリガー

#### Vercel設定
- [ ] Vercelプロジェクト作成
- [ ] GitHub連携
- [ ] 環境変数設定
- [ ] デプロイ確認

### 🔐 認証機能（Day 2-3）

#### ユーザー登録
- [ ] サインアップページ作成（/signup）
- [ ] サインアップフォームコンポーネント
  - [ ] メールアドレス入力
  - [ ] パスワード入力（8文字以上、大文字小文字数字）
  - [ ] パスワード確認
  - [ ] バリデーション実装（Zod）
- [ ] Supabase Auth連携
  - [ ] ユーザー作成処理
  - [ ] 確認メール送信
  - [ ] エラーハンドリング
- [ ] テスト項目
  - [ ] 正常な登録フロー
  - [ ] 重複メールアドレスチェック
  - [ ] パスワード要件チェック
  - [ ] 確認メール送信確認

#### ログイン
- [ ] ログインページ作成（/login）
- [ ] ログインフォームコンポーネント
  - [ ] メールアドレス入力
  - [ ] パスワード入力
  - [ ] ログイン状態保持チェックボックス
- [ ] ログイン処理実装
  - [ ] Supabase Auth認証
  - [ ] JWTトークン管理
  - [ ] リダイレクト処理
- [ ] ログイン試行制限（5回失敗で15分ロック）
- [ ] テスト項目
  - [ ] 正常なログイン
  - [ ] 無効な認証情報
  - [ ] アカウントロック機能

#### パスワードリセット
- [ ] パスワードリセット画面
- [ ] リセットメール送信処理
- [ ] 新パスワード設定画面
- [ ] 全デバイスログアウト処理
- [ ] テスト項目
  - [ ] リセットフロー全体
  - [ ] 有効期限チェック（24時間）

#### 認証ミドルウェア
- [ ] 認証状態チェック
- [ ] 未認証時のリダイレクト
- [ ] 認証情報の永続化

### 🎨 基本レイアウト（Day 4）

#### 共通コンポーネント
- [ ] ヘッダーコンポーネント
  - [ ] ロゴ表示
  - [ ] タイマー表示（グローバル）
  - [ ] ユーザーメニュー
  - [ ] エラー報告ボタン
- [ ] サイドバーコンポーネント
  - [ ] ナビゲーションメニュー
  - [ ] アクティブ状態表示
  - [ ] 折りたたみ機能（タブレット）
- [ ] レイアウトラッパー
  - [ ] 認証チェック
  - [ ] レスポンシブ対応

#### ルーティング設定
- [ ] (auth)グループ設定
- [ ] (dashboard)グループ設定
- [ ] 404ページ
- [ ] エラーページ

### ⏱️ タイマー機能（Day 5-8）

#### タイマーバー
- [ ] タイマーバーコンポーネント作成
- [ ] 説明文入力フィールド
  - [ ] 最大500文字制限
  - [ ] オートコンプリート実装
  - [ ] 過去7日間のdescription取得
- [ ] プロジェクト選択ドロップダウン
  - [ ] アクティブプロジェクトのみ表示
  - [ ] 最近使用5件を上部表示
  - [ ] "No Project"オプション
  - [ ] カラーボーダー変更
- [ ] タイマー表示
  - [ ] HH:MM:SS形式
  - [ ] 24時間超過時の表示（1d 01:23:45）
  - [ ] 実行中は赤文字
- [ ] 開始/停止ボタン
  - [ ] アイコン切り替え
  - [ ] キーボードショートカット（Space）

#### タイマー処理
- [ ] Zustandストア作成（timerStore）
- [ ] タイマー開始処理
  - [ ] 実行中チェック
  - [ ] time_entries作成
  - [ ] is_running=true設定
- [ ] タイマー停止処理
  - [ ] end_time記録
  - [ ] duration計算
  - [ ] is_running=false更新
- [ ] ページリロード対応
  - [ ] 実行中タイマーの復元
  - [ ] 経過時間の計算
- [ ] 1秒ごとの更新処理
- [ ] 30秒ごとの自動保存

#### タイムエントリーリスト
- [ ] エントリーリストコンポーネント
- [ ] データ取得
  - [ ] time_entriesとprojectsのJOIN
  - [ ] 今日のデータをデフォルト表示
  - [ ] start_time降順ソート
- [ ] グループ化表示
  - [ ] 日付でグループ（今日/昨日/日付）
  - [ ] グループ小計
  - [ ] 折りたたみ機能
- [ ] エントリーアクション
  - [ ] 継続ボタン
  - [ ] インライン編集
  - [ ] 削除（確認ダイアログ付き）
- [ ] 今日の合計時間表示

#### 手動エントリー作成
- [ ] 手動入力モーダル/フォーム
- [ ] 日付選択（過去90日まで）
- [ ] 時刻入力
  - [ ] 開始時刻
  - [ ] 終了時刻
  - [ ] 時間幅入力
- [ ] 時間重複チェック
- [ ] バリデーション
  - [ ] 最大24時間
  - [ ] 未来の日付不可

#### リアルタイム同期
- [ ] Supabase Realtime設定
- [ ] 変更監視
  - [ ] INSERT
  - [ ] UPDATE
  - [ ] DELETE
- [ ] 他デバイスとの同期
- [ ] 競合解決

#### オフライン対応
- [ ] ローカルストレージ保存
- [ ] オフライン検知
- [ ] オンライン復帰時の同期
- [ ] 同期待ちキュー管理

### 📁 プロジェクト管理（Day 9-10）

#### プロジェクト一覧
- [ ] プロジェクト一覧ページ
- [ ] プロジェクトカード表示
  - [ ] プロジェクト名
  - [ ] カラーアイコン
  - [ ] 統計情報（合計時間、今週の時間）
- [ ] フィルタリング
  - [ ] Active/Archivedタブ
  - [ ] 検索機能（プロジェクト名）
- [ ] ソート機能
  - [ ] 最終更新日
  - [ ] 名前
  - [ ] 作業時間
  - [ ] 作成日

#### プロジェクト作成/編集
- [ ] プロジェクト作成モーダル
- [ ] 入力フォーム
  - [ ] プロジェクト名（必須、最大100文字）
  - [ ] カラー選択（12色）
  - [ ] メモ（任意、最大1000文字）
- [ ] バリデーション
  - [ ] 名前の重複チェック
  - [ ] 必須項目チェック
- [ ] 編集機能
  - [ ] 既存データの読み込み
  - [ ] 更新処理

#### プロジェクト削除
- [ ] 削除確認ダイアログ
- [ ] 関連エントリーの表示
  - [ ] エントリー数
  - [ ] 合計時間
- [ ] 削除オプション
  - [ ] エントリーを保持（project_id=null）
  - [ ] エントリーも削除
- [ ] トランザクション処理

#### プロジェクトストア
- [ ] Zustandストア作成（projectStore）
- [ ] CRUD操作
  - [ ] fetchProjects
  - [ ] createProject
  - [ ] updateProject
  - [ ] deleteProject
- [ ] キャッシュ管理

### 📊 レポート機能（Day 11-13）

#### サマリーレポート
- [ ] レポートページ作成
- [ ] 期間選択UI
  - [ ] プリセット（今日/昨日/今週/先週/今月/先月）
  - [ ] カスタム期間（カレンダー）
- [ ] グループ化オプション
  - [ ] プロジェクト別
  - [ ] 日付別
- [ ] データ集計処理
  - [ ] 合計時間計算
  - [ ] グループ別集計
- [ ] ビジュアライゼーション
  - [ ] 円グラフ（Recharts）
  - [ ] 棒グラフ（Recharts）
  - [ ] データテーブル

#### 詳細レポート
- [ ] タイムシート表示
- [ ] フィルタリング
  - [ ] プロジェクト選択
  - [ ] 期間指定
- [ ] ページネーション
  - [ ] 50/100/200件切り替え
  - [ ] ページ番号表示
- [ ] インライン編集
- [ ] 一括操作
  - [ ] 複数選択（Shift/Ctrl）
  - [ ] プロジェクト一括変更
  - [ ] 一括削除

#### エクスポート機能
- [ ] CSVエクスポート
  - [ ] データ整形
  - [ ] 固定フォーマット（YYYY/MM/DD HH:mm:ss）
  - [ ] ダウンロード処理
- [ ] PDFエクスポート
  - [ ] レイアウト作成
  - [ ] ロゴアップロード
  - [ ] PDF生成

### 🏠 ダッシュボード（Day 14）

#### 統計カード
- [ ] 今日の作業時間カード
- [ ] 今週の作業時間カード
- [ ] 今月の作業時間カード
- [ ] 日次目標カード
- [ ] リアルタイム更新
- [ ] 前期間比較表示

#### アクティビティグラフ
- [ ] 7日間の棒グラフ
- [ ] 目標ライン表示
- [ ] ホバー詳細表示
- [ ] データ取得・集計

#### プロジェクト進捗
- [ ] アクティブプロジェクトリスト
- [ ] 進捗バー表示
- [ ] 時間と割合表示

#### 最近のアクティビティ
- [ ] アクティビティフィード
- [ ] 相対時間表示
- [ ] 無限スクロール
- [ ] リアルタイム更新

#### ウィジェットカスタマイズ
- [ ] ドラッグ&ドロップ実装
- [ ] サイズ変更（S/M/L）
- [ ] レイアウト保存（localStorage）
- [ ] リセット機能

### ⚙️ 設定機能（Day 15）

#### プロファイル設定
- [ ] プロファイル編集画面
- [ ] 基本情報編集
  - [ ] 表示名
  - [ ] アバター画像アップロード
  - [ ] 週の開始日
- [ ] 画像アップロード処理
  - [ ] ファイルサイズチェック（5MB）
  - [ ] 画像形式チェック
  - [ ] Supabase Storage連携

#### 通知設定
- [ ] 通知設定画面
- [ ] メール通知
  - [ ] 日次レポート ON/OFF
  - [ ] 週次レポート ON/OFF
  - [ ] 送信時刻設定
- [ ] ブラウザ通知
  - [ ] 許可リクエスト
  - [ ] テスト通知
- [ ] 長時間タイマー警告設定

#### データ管理
- [ ] データエクスポート
  - [ ] 全データ/期間指定
  - [ ] JSON/CSV形式
  - [ ] プログレス表示
- [ ] データインポート
  - [ ] ファイル選択
  - [ ] フォーマット検証
  - [ ] インポート処理
  - [ ] エラー表示
- [ ] データ削除
  - [ ] 期間指定削除
  - [ ] 全データ削除
  - [ ] アカウント削除
  - [ ] 確認ステップ

### 🐛 エラーログ収集機能（Day 16）

#### クライアントロガー実装
- [ ] ロガークラス作成
- [ ] エラーハンドラー設定
  - [ ] window.onerror
  - [ ] unhandledrejection
- [ ] コンソールオーバーライド（開発環境）
- [ ] セッションID生成
- [ ] バッチ処理実装
  - [ ] キュー管理
  - [ ] 5秒または10件でフラッシュ
- [ ] ローカルストレージフォールバック

#### ログ送信API
- [ ] POST /api/client-logs エンドポイント
- [ ] バッチインサート処理
- [ ] エラーハンドリング
- [ ] レート制限

#### 手動エラー報告
- [ ] エラー報告ボタン（ヘッダー）
- [ ] 報告フォーム
  - [ ] 問題の説明入力
  - [ ] 現在のURL記録
  - [ ] 直近ログの添付
- [ ] 送信処理
- [ ] 成功/エラー通知

#### ログビューワー（管理者用）
- [ ] ログ一覧画面
- [ ] フィルタリング機能
  - [ ] ユーザーID
  - [ ] セッションID
  - [ ] ログレベル
  - [ ] 期間
- [ ] ログ詳細表示
  - [ ] スタックトレース
  - [ ] メタデータ
- [ ] ページネーション
- [ ] CSVエクスポート
- [ ] アクセス制御（管理者のみ）

#### プライバシー対応
- [ ] パスワードフィールドのマスキング
- [ ] 30日での自動削除
- [ ] 個人情報の除外処理

### 🧪 テストとデバッグ（Day 17）

#### 単体テスト
- [ ] ユーティリティ関数のテスト
  - [ ] 時間フォーマット
  - [ ] 日付処理
  - [ ] バリデーション
- [ ] カスタムフックのテスト
- [ ] コンポーネントテスト

#### 統合テスト
- [ ] API連携テスト
- [ ] 認証フローテスト
- [ ] データ同期テスト

#### E2Eテスト
- [ ] 主要ユーザーフロー
  - [ ] サインアップ→ログイン→タイマー使用
  - [ ] プロジェクト作成→時間記録→レポート確認
- [ ] クロスブラウザテスト

#### パフォーマンス最適化
- [ ] バンドルサイズ確認
- [ ] 画像最適化
- [ ] 遅延読み込み実装
- [ ] キャッシュ戦略

### 🚀 デプロイと公開（Day 18）

#### 最終確認
- [ ] 環境変数の確認
- [ ] RLSポリシーの動作確認
- [ ] エラーハンドリング確認
- [ ] レスポンシブデザイン確認

#### Vercelデプロイ
- [ ] プロダクションビルド
- [ ] デプロイ実行
- [ ] 動作確認
- [ ] ドメイン設定（必要に応じて）

#### ドキュメント作成
- [ ] README.md更新
- [ ] 環境構築手順
- [ ] API仕様書
- [ ] 運用マニュアル

### 📝 チェックポイント

#### 各機能実装後の確認事項
- [ ] TypeScriptの型エラーがない
- [ ] ESLintエラーがない
- [ ] コンソールエラーがない
- [ ] レスポンシブデザインが機能している
- [ ] RLSが正しく動作している
- [ ] エラーログが記録されている

#### セキュリティチェック
- [ ] 認証が必要なページは保護されている
- [ ] APIエンドポイントに認証がある
- [ ] XSS対策されている
- [ ] SQLインジェクション対策されている

#### パフォーマンスチェック
- [ ] ページ読み込みが3秒以内
- [ ] API応答が1秒以内
- [ ] メモリリークがない
- [ ] 不要な再レンダリングがない